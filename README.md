# Анализатор TLI в YDB

Утилита для поиска причин ошибок "Transaction locks invalidated" по серверным логам ydb

Собирает из серверных логов полную картину причин, по которым возникает данная ошибка

## Требования

Нужный функционал логирования доступен в 25.1 свежей версии

## Настройка сервера

По умолчанию ydb не логирует информацию об ошибках TLI и выполняемых запросах.
Чтобы включить сбор этой информации нужно добавить в динамический конфиг следующие настройки:

```yaml
      log_config: !inherit
        entry: !append
          - component: DATA_INTEGRITY
            level: 8
      data_integrity_trails_config: !inherit
        query_text_log_mode: ORIGINAL
```

После применения конфига необходимо перезагрузить узлы базы данных.

Включать секцию `data_integrity_trails_config` не обязательно, по-умолчанию в лог вместо текста запроса будут выводиться его хэш.
В целом, если клиентское приложение может логировать запросы самостоятельно, лучше не писать их в лог сервера.

ВАЖНО: после применения этих настроек в лог будет писаться очень подробная информация обо ВСЕХ выполняемых запросах и блокировках.
На каждый отправляемый запрос в лог будет записано около 10-15 строк. Настролько подробное логирование отрицательно сказывается на производительности
сервера и сильно увеличивает размер логов. Не рекомендуется включать эту настройки в прод-окружении!

## Настройка логирования

По умолчанию ydbd пишет логи в systemd, который отбрасывает часть строк, если приложение пишет слишком много. 
Для целей анализа нам важно собрать все строки, поэтому нужно перенастроить логирование

### Вариант 1: Снять ограничения по объему логов в systemd
Для этого нужно прописать в  /etc/systemd/journald.conf следующие настройки:

```
RateLimitInterval=0
RateLimitBurst=0
```

При этом ограничение будет снято со всех процессов, запускаемых через systemd

### Вариант 2: Дополнительно сохранять логи в текстовые файлы. 
Для этого нужно дописать в systemd-юниты для динамических нод следующие настройки в раздел [Service]:
```
StandardOutput=append:/var/log/ydbd-database-a.log
StandardError=append:/var/log/ydbd-database-a.log
```
Это нужно сделать в каждом юнит-файле.
Важно помнить, что каждый процесс должен писать лог в отдельный файл.

## Формат вывода

Инструмент может генерировать отчет в одном из двух форматов:
 - yaml - содержит все технические поля, но не очень удобно читать
 - sql - содержит только наиболее интересные метаданные и текст запросов в простой текстовой форме
 Формат выбирается ключом `--output-format`


## Использование

На вход приложения нужно подать объединенные логи со всех серверов. Для ускорения анализа нужно оставить только строки, содержащие DATA_INTEGRITY.
Желательно дополнительно ограничить период времени, за который анализируются логи. 

Сортировать строки не требуется. 

Пример использования: 
```bash
grep DATA_INTEGRITY *.log | grep "2025-10-22T12:06" | python tli_analyzer.py  --output-format sql >report.sql 2>report.log

```
